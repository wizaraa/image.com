<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>اختبار الإرسال</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        button {
            background: #4CAF50;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px;
        }
        button:hover {
            background: #45a049;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
            display: none;
        }
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            text-align: left;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="test-box">
        <h1>🔧 اختبار الاتصال المباشر</h1>
        <p>هذه الصفحة لاختبار الإرسال إلى Google Sheets</p>
        
        <div>
            <label for="scriptUrl">رابط Google Apps Script:</label><br>
            <input type="text" id="scriptUrl" style="width: 100%; padding: 10px; margin: 10px 0;" 
                   value="https://script.google.com/macros/s/AKfycbyAnQqHdzYjEfZdW4DJbSen8H6dz2nLJuWZVwx6TzfoE4nfa2fxRDxb6xP8BxW2uPnS/exec">
        </div>
        
        <button onclick="testConnection()">🚀 اختبار الاتصال</button>
        <button onclick="sendRealData()">📤 إرسال بيانات حقيقية</button>
        <button onclick="clearLog()">🗑️ مسح السجل</button>
        
        <div id="status" class="status"></div>
        <div id="log" class="log"></div>
    </div>

    <script>
        let logContent = '';

        function log(message) {
            const timestamp = new Date().toLocaleTimeString('ar-IQ');
            logContent += `[${timestamp}] ${message}\n`;
            document.getElementById('log').textContent = logContent;
            console.log(message);
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = isError ? 'status error' : 'status success';
            statusDiv.style.display = 'block';
        }

        function clearLog() {
            logContent = '';
            document.getElementById('log').textContent = '';
            document.getElementById('status').style.display = 'none';
        }

        async function testConnection() {
            const scriptUrl = document.getElementById('scriptUrl').value.trim();
            
            if (!scriptUrl) {
                showStatus('الرجاء إدخال رابط Google Apps Script', true);
                return;
            }

            log('🔍 بدء اختبار الاتصال...');
            log('🔗 الرابط: ' + scriptUrl);

            try {
                // اختبار GET أولاً
                log('📡 اختبار GET request...');
                const getResponse = await fetch(scriptUrl, { method: 'GET' });
                const getResult = await getResponse.text();
                log('✅ GET response: ' + getResult);

                // اختبار POST
                log('📤 اختبار POST request...');
                const testData = {
                    test: true,
                    timestamp: new Date().toLocaleString('ar-IQ'),
                    page_url: 'صفحة الاختبار المباشر',
                    user_agent: navigator.userAgent,
                    test_id: 'DIRECT_TEST_' + Date.now()
                };

                log('📦 البيانات المرسلة: ' + JSON.stringify(testData, null, 2));

                const formData = 'data=' + encodeURIComponent(JSON.stringify(testData));
                log('📝 Form data length: ' + formData.length + ' characters');

                const postResponse = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                log('📬 POST status: ' + postResponse.status);
                
                try {
                    const postResult = await postResponse.text();
                    log('✅ POST response: ' + postResult);
                } catch (e) {
                    log('⚠️ Could not read POST response (this is normal with no-cors)');
                }

                showStatus('✅ تم الاختبار بنجاح! تحقق من Google Sheet');

            } catch (error) {
                log('❌ خطأ في الاختبار: ' + error.message);
                showStatus('❌ فشل الاختبار: ' + error.message, true);
            }
        }

        async function sendRealData() {
            const scriptUrl = document.getElementById('scriptUrl').value.trim();
            
            if (!scriptUrl) {
                showStatus('الرجاء إدخال رابط Google Apps Script', true);
                return;
            }

            log('🚀 إرسال بيانات حقيقية...');

            // جمع معلومات حقيقية
            const data = {
                timestamp: new Date().toLocaleString('ar-IQ'),
                page_url: window.location.href,
                referrer: document.referrer || 'مباشر',
                device_type: /Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'موبايل' : 'كمبيوتر',
                browser: getBrowser(),
                operating_system: getOS(),
                screen_resolution: screen.width + 'x' + screen.height,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                language: navigator.language,
                user_agent: navigator.userAgent,
                test_id: 'REAL_DATA_' + Date.now()
            };

            log('📊 البيانات الحقيقية: ' + JSON.stringify(data, null, 2));

            try {
                const formData = 'data=' + encodeURIComponent(JSON.stringify(data));
                
                const response = await fetch(scriptUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: formData
                });

                log('✅ تم إرسال البيانات الحقيقية');
                showStatus('✅ تم إرسال البيانات الحقيقية! تحقق من Google Sheet');

                // محاولة إضافية بـ GET
                setTimeout(async () => {
                    try {
                        const getUrl = scriptUrl + '?data=' + encodeURIComponent(JSON.stringify(data));
                        await fetch(getUrl, { method: 'GET' });
                        log('✅ تم إرسال نسخة احتياطية بـ GET');
                    } catch (e) {
                        log('⚠️ فشلت النسخة الاحتياطية: ' + e.message);
                    }
                }, 1000);

            } catch (error) {
                log('❌ خطأ في إرسال البيانات: ' + error.message);
                showStatus('❌ فشل الإرسال: ' + error.message, true);
            }
        }

        function getBrowser() {
            const ua = navigator.userAgent;
            if (ua.includes('Chrome')) return 'كروم';
            if (ua.includes('Firefox')) return 'فايرفوكس';
            if (ua.includes('Safari')) return 'سفاري';
            if (ua.includes('Edge')) return 'إيدج';
            return 'غير معروف';
        }

        function getOS() {
            const ua = navigator.userAgent;
            if (ua.includes('Windows')) return 'ويندوز';
            if (ua.includes('Mac')) return 'ماك';
            if (ua.includes('Linux')) return 'لينكس';
            if (ua.includes('Android')) return 'أندرويد';
            if (ua.includes('iOS')) return 'iOS';
            return 'غير معروف';
        }

        // تشغيل اختبار تلقائي عند تحميل الصفحة
        window.addEventListener('load', function() {
            log('🏁 تم تحميل صفحة الاختبار');
            log('🌐 الرابط الحالي: ' + window.location.href);
            log('📱 نوع الجهاز: ' + (/Mobile|Android|iPhone|iPad/.test(navigator.userAgent) ? 'موبايل' : 'كمبيوتر'));
            log('🔧 جاهز للاختبار!');
        });
    </script>
</body>
</html>
